# Coturn TURN server for WebRTC relay
# Exposed via TCP ingress on turn.opensensor.io
apiVersion: v1
kind: Secret
metadata:
  name: coturn-secret
  namespace: lightnvr
type: Opaque
stringData:
  turn-password: "lightnvr-turn-2024"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coturn
  namespace: lightnvr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: coturn
  template:
    metadata:
      labels:
        app: coturn
    spec:
      containers:
        - name: coturn
          image: coturn/coturn:4.6.2-alpine
          command: ["/bin/sh", "-c"]
          args:
            - |
              exec turnserver \
                --listening-port=3478 \
                --realm=turn.opensensor.io \
                --fingerprint \
                --lt-cred-mech \
                --user=lightnvr:${TURN_PASSWORD} \
                --no-cli \
                --no-multicast-peers \
                --verbose \
                --external-ip=129.212.197.123/${POD_IP} \
                --listening-ip=0.0.0.0 \
                --min-port=49152 \
                --max-port=49172 \
                --no-dtls
          env:
            - name: TURN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: coturn-secret
                  key: turn-password
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 3478
              protocol: TCP
              name: turn-tcp
            - containerPort: 3478
              protocol: UDP
              name: turn-udp
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: coturn
  namespace: lightnvr
spec:
  type: LoadBalancer
  # Preserve client source IP for UDP
  externalTrafficPolicy: Local
  selector:
    app: coturn
  ports:
    - name: turn-tcp
      port: 3478
      targetPort: 3478
      protocol: TCP
    - name: turn-udp
      port: 3478
      targetPort: 3478
      protocol: UDP
    # Relay port range (small range for ingress exposure)
    - name: relay-49152
      port: 49152
      targetPort: 49152
      protocol: UDP
    - name: relay-49153
      port: 49153
      targetPort: 49153
      protocol: UDP
    - name: relay-49154
      port: 49154
      targetPort: 49154
      protocol: UDP
    - name: relay-49155
      port: 49155
      targetPort: 49155
      protocol: UDP
    - name: relay-49156
      port: 49156
      targetPort: 49156
      protocol: UDP
    - name: relay-49157
      port: 49157
      targetPort: 49157
      protocol: UDP
    - name: relay-49158
      port: 49158
      targetPort: 49158
      protocol: UDP
    - name: relay-49159
      port: 49159
      targetPort: 49159
      protocol: UDP
    - name: relay-49160
      port: 49160
      targetPort: 49160
      protocol: UDP
    - name: relay-49161
      port: 49161
      targetPort: 49161
      protocol: UDP
    - name: relay-49162
      port: 49162
      targetPort: 49162
      protocol: UDP
    - name: relay-49163
      port: 49163
      targetPort: 49163
      protocol: UDP
    - name: relay-49164
      port: 49164
      targetPort: 49164
      protocol: UDP
    - name: relay-49165
      port: 49165
      targetPort: 49165
      protocol: UDP
    - name: relay-49166
      port: 49166
      targetPort: 49166
      protocol: UDP
    - name: relay-49167
      port: 49167
      targetPort: 49167
      protocol: UDP
    - name: relay-49168
      port: 49168
      targetPort: 49168
      protocol: UDP
    - name: relay-49169
      port: 49169
      targetPort: 49169
      protocol: UDP
    - name: relay-49170
      port: 49170
      targetPort: 49170
      protocol: UDP
    - name: relay-49171
      port: 49171
      targetPort: 49171
      protocol: UDP
    - name: relay-49172
      port: 49172
      targetPort: 49172
      protocol: UDP
