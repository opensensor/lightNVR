const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./preact-app-CvC8761_.js","./preact-app-B50Zg-w-.css"])))=>i.map(i=>d[i]);
var q=Object.freeze,Me=Object.defineProperty;var D=(e,t)=>q(Me(e,"raw",{value:q(t||e.slice())}));import{h as $,c as f,d as x,A as _e,y as K,D as ze,_ as Ae,f as Oe}from"./preact-app-CvC8761_.js";import{C as Le}from"./LoadingIndicator-kkUqGZXC.js";import{f as M,e as U}from"./fetch-utils-GN-4zfXA.js";var Q,X;function Ue({filters:e,setFilters:t,pagination:o,setPagination:s,streams:a,filtersVisible:c,applyFilters:n,resetFilters:p,handleDateRangeChange:h,setDefaultDateRange:b}){return $(X||(X=D(['\n    <aside id="filters-sidebar" \n           class=','>\n      <div class="filter-group mb-4">\n        <h3 class="text-lg font-medium mb-2 pb-1 border-b border-gray-200 dark:border-gray-700">Date Range</h3>\n        <div class="filter-option mb-2">\n          <label for="date-range-select" class="block mb-1 text-sm font-medium">Quick Select:</label>\n          <select id="date-range-select" \n                  class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                  value=',"\n                  onChange=",'>\n            <option value="today">Today</option>\n            <option value="yesterday">Yesterday</option>\n            <option value="last7days">Last 7 Days</option>\n            <option value="last30days">Last 30 Days</option>\n            <option value="custom">Custom Range</option>\n          </select>\n        </div>\n        \n        <div id="custom-date-range" \n             class="filter-option space-y-3"\n             style=','>\n          <div class="space-y-1">\n            <label for="start-date" class="block text-sm font-medium">Start Date:</label>\n            <input type="date" id="start-date" \n                   class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                   value=',"\n                   onChange=",' />\n            <div class="mt-1">\n              <label for="start-time" class="block text-sm font-medium">Time:</label>\n              <input type="time" id="start-time" \n                     class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                     value=',"\n                     onChange=",' />\n            </div>\n          </div>\n          \n          <div class="space-y-1">\n            <label for="end-date" class="block text-sm font-medium">End Date:</label>\n            <input type="date" id="end-date" \n                   class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                   value=',"\n                   onChange=",' />\n            <div class="mt-1">\n              <label for="end-time" class="block text-sm font-medium">Time:</label>\n              <input type="time" id="end-time" \n                     class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                     value=',"\n                     onChange=",' />\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div class="filter-group mb-4">\n        <h3 class="text-lg font-medium mb-2 pb-1 border-b border-gray-200 dark:border-gray-700">Stream</h3>\n        <div class="filter-option">\n          <select id="stream-filter" \n                  class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                  value=',"\n                  onChange=",'>\n            <option value="all">All Streams</option>\n            ','\n          </select>\n        </div>\n      </div>\n      \n      <div class="filter-group mb-4">\n        <h3 class="text-lg font-medium mb-2 pb-1 border-b border-gray-200 dark:border-gray-700">Recording Type</h3>\n        <div class="filter-option">\n          <select id="detection-filter" \n                  class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                  value=',"\n                  onChange=",'>\n            <option value="all">All Recordings</option>\n            <option value="detection">Detection Events Only</option>\n          </select>\n        </div>\n      </div>\n      \n      <div class="filter-group mb-4">\n        <h3 class="text-lg font-medium mb-2 pb-1 border-b border-gray-200 dark:border-gray-700">Display Options</h3>\n        <div class="filter-option">\n          <label for="page-size" class="block mb-1 text-sm font-medium">Items per page:</label>\n          <select id="page-size" \n                  class="w-full p-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"\n                  value=',"\n                  onChange=",'>\n            <option value="10">10</option>\n            <option value="20">20</option>\n            <option value="50">50</option>\n            <option value="100">100</option>\n          </select>\n        </div>\n      </div>\n      \n      <div class="filter-actions flex space-x-2">\n        <button id="apply-filters-btn" \n                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"\n                onClick=','>\n          Apply Filters\n        </button>\n        <button id="reset-filters-btn" \n                class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"\n                onClick=',">\n          Reset\n        </button>\n      </div>\n    </aside>\n  "])),"filters-sidebar w-full md:w-64 bg-white dark:bg-gray-800 rounded-lg shadow p-4 md:sticky md:top-4 md:self-start transition-all duration-300 ".concat(c?"":"hidden md:block"),e.dateRange,h,e.dateRange==="custom"?"display: block":"display: none",e.startDate,l=>t(m=>({...m,startDate:l.target.value})),e.startTime,l=>t(m=>({...m,startTime:l.target.value})),e.endDate,l=>t(m=>({...m,endDate:l.target.value})),e.endTime,l=>t(m=>({...m,endTime:l.target.value})),e.streamId,l=>t(m=>({...m,streamId:l.target.value})),a.map(l=>$(Q||(Q=D(["\n              <option key="," value=",">","</option>\n            "])),l.name,l.name,l.name)),e.recordingType,l=>t(m=>({...m,recordingType:l.target.value})),o.pageSize,l=>s(m=>({...m,pageSize:parseInt(l.target.value,10)})),n,p)}var Z,ee;function Be({activeFiltersDisplay:e,removeFilter:t,hasActiveFilters:o}){return o?$(ee||(ee=D(['\n    <div id="active-filters" \n         class="active-filters mb-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg flex flex-wrap gap-2">\n      ',"\n    </div>\n  "])),e.map((s,a)=>$(Z||(Z=D(["\n        <div key=",' class="filter-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-200">\n          <span>','</span>\n          <button class="ml-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 focus:outline-none"\n                  onClick=',">\n            ×\n          </button>\n        </div>\n      "])),a,s.label,()=>t(s.key)))):null}const B={formatDateTime:e=>e?new Date(e).toLocaleString():"",formatDuration:e=>{if(!e)return"00:00:00";const t=Math.floor(e/3600),o=Math.floor(e%3600/60),s=Math.floor(e%60);return[t.toString().padStart(2,"0"),o.toString().padStart(2,"0"),s.toString().padStart(2,"0")].join(":")},formatFileSize:e=>{if(!e)return"0 B";const t=["B","KB","MB","GB","TB"];let o=0,s=e;for(;s>=1024&&o<t.length-1;)s/=1024,o++;return"".concat(s.toFixed(1)," ").concat(t[o])}};var te,ae,re,oe,se,ne,ie;function He({recordings:e,sortField:t,sortDirection:o,sortBy:s,selectedRecordings:a,toggleRecordingSelection:c,selectAll:n,toggleSelectAll:p,getSelectedCount:h,openDeleteModal:b,playRecording:l,downloadRecording:m,deleteRecording:w,recordingsTableBodyRef:S,pagination:_}){return $(ie||(ie=D(['\n    <div class="recordings-container bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden w-full">\n      <div class="batch-actions p-3 border-b border-gray-200 dark:border-gray-700 flex flex-wrap gap-2 items-center">\n        <div class="selected-count text-sm text-gray-600 dark:text-gray-400 mr-2">\n          ','\n        </div>\n        <button \n          class="px-3 py-1.5 bg-red-600 text-white rounded hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"\n          disabled=',"\n          onClick=",'>\n          Delete Selected\n        </button>\n        <button \n          class="px-3 py-1.5 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"\n          onClick=','>\n          Delete All Filtered\n        </button>\n      </div>\n      <div class="overflow-x-auto">\n        <table id="recordings-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">\n          <thead class="bg-gray-50 dark:bg-gray-700">\n            <tr>\n              <th class="w-10 px-4 py-3">\n                <input \n                  type="checkbox" \n                  checked=',"\n                  onChange=",'\n                  class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"\n                />\n              </th>\n              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"\n                  onClick=','>\n                <div class="flex items-center">\n                  Stream\n                  ','\n                </div>\n              </th>\n              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"\n                  onClick=','>\n                <div class="flex items-center">\n                  Start Time\n                  ','\n                </div>\n              </th>\n              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">\n                Duration\n              </th>\n              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"\n                  onClick=','>\n                <div class="flex items-center">\n                  Size\n                  ','\n                </div>\n              </th>\n              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">\n                Detections\n              </th>\n              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody ref=',' class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">\n            ',"\n          </tbody>\n        </table>\n      </div>\n    </div>\n  "])),h()>0?"".concat(h()," recording").concat(h()!==1?"s":""," selected"):"No recordings selected",h()===0,()=>b("selected"),()=>b("all"),n,p,()=>s("stream_name"),t==="stream_name"&&$(te||(te=D(['\n                    <span class="sort-icon ml-1">',"</span>\n                  "])),o==="asc"?"▲":"▼"),()=>s("start_time"),t==="start_time"&&$(ae||(ae=D(['\n                    <span class="sort-icon ml-1">',"</span>\n                  "])),o==="asc"?"▲":"▼"),()=>s("size_bytes"),t==="size_bytes"&&$(re||(re=D(['\n                    <span class="sort-icon ml-1">',"</span>\n                  "])),o==="asc"?"▲":"▼"),S,e.length===0?$(oe||(oe=D(['\n              <tr>\n                <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">\n                  ',"\n                </td>\n              </tr>\n            "])),_.totalItems===0?"No recordings found":"Loading recordings..."):e.map(k=>$(ne||(ne=D(["\n              <tr key=",' class="hover:bg-gray-50 dark:hover:bg-gray-700">\n                <td class="px-4 py-4 whitespace-nowrap">\n                  <input \n                    type="checkbox" \n                    checked=',"\n                    onChange=",'\n                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"\n                  />\n                </td>\n                <td class="px-6 py-4 whitespace-nowrap">','</td>\n                <td class="px-6 py-4 whitespace-nowrap">','</td>\n                <td class="px-6 py-4 whitespace-nowrap">','</td>\n                <td class="px-6 py-4 whitespace-nowrap">','</td>\n                <td class="px-6 py-4 whitespace-nowrap">\n                  ','\n                </td>\n                <td class="px-6 py-4 whitespace-nowrap">\n                  <div class="flex space-x-2">\n                    <button class="p-1 rounded-full text-blue-600 hover:bg-blue-100 dark:text-blue-400 dark:hover:bg-blue-900 focus:outline-none"\n                            onClick=','\n                            title="Play">\n                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">\n                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>\n                      </svg>\n                    </button>\n                    <button class="p-1 rounded-full text-green-600 hover:bg-green-100 dark:text-green-400 dark:hover:bg-green-900 focus:outline-none"\n                            onClick=','\n                            title="Download">\n                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">\n                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>\n                      </svg>\n                    </button>\n                    <button class="p-1 rounded-full text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900 focus:outline-none"\n                            onClick=','\n                            title="Delete">\n                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">\n                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>\n                      </svg>\n                    </button>\n                  </div>\n                </td>\n              </tr>\n            '])),k.id,!!a[k.id],()=>c(k.id),k.stream||"",B.formatDateTime(k.start_time),B.formatDuration(k.duration),k.size||"",k.has_detections?$(se||(se=D(['\n                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">\n                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>\n                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>\n                      </svg>\n                      Yes\n                    </span>\n                  ']))):"",()=>l(k),()=>m(k),()=>w(k))))}var le;function Ve({pagination:e,goToPage:t}){return $(le||(le=D(['\n    <div class="pagination-controls flex flex-col sm:flex-row justify-between items-center p-4 border-t border-gray-200 dark:border-gray-700">\n      <div class="pagination-info text-sm text-gray-600 dark:text-gray-400 mb-2 sm:mb-0">\n        Showing <span id="pagination-showing">',"-",'</span> of <span id="pagination-total">','</span> recordings\n      </div>\n      <div class="pagination-buttons flex items-center space-x-1">\n        <button id="pagination-first" \n                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"\n                title="First Page"\n                onClick=',"\n                disabled=",'>\n          «\n        </button>\n        <button id="pagination-prev" \n                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"\n                title="Previous Page"\n                onClick=',"\n                disabled=",'>\n          ‹\n        </button>\n        <span id="pagination-current" class="px-2 text-sm text-gray-700 dark:text-gray-300">\n          Page '," of ",'\n        </span>\n        <button id="pagination-next" \n                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"\n                title="Next Page"\n                onClick=',"\n                disabled=",'>\n          ›\n        </button>\n        <button id="pagination-last" \n                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"\n                title="Last Page"\n                onClick=',"\n                disabled=",">\n          »\n        </button>\n      </div>\n    </div>\n  "])),e.startItem,e.endItem,e.totalItems,()=>t(1),e.currentPage===1,()=>t(e.currentPage-1),e.currentPage===1,e.currentPage,e.totalPages,()=>t(e.currentPage+1),e.currentPage===e.totalPages,()=>t(e.totalPages),e.currentPage===e.totalPages)}const v={loadStreams:async()=>{try{return await M("/api/streams",{timeout:15e3,retries:2,retryDelay:1e3})||[]}catch(e){return console.error("Error loading streams for filter:",e),f("Error loading streams: "+e.message),[]}},getDateRangeFromPreset:e=>{const t=new Date,o=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59),s=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);let a,c;switch(e){case"today":a=s.toISOString(),c=o.toISOString();break;case"yesterday":const n=new Date(s);n.setDate(n.getDate()-1);const p=new Date(n);p.setHours(23,59,59),a=n.toISOString(),c=p.toISOString();break;case"last7days":const h=new Date(s);h.setDate(h.getDate()-7),a=h.toISOString(),c=o.toISOString();break;case"last30days":const b=new Date(s);b.setDate(b.getDate()-30),a=b.toISOString(),c=o.toISOString();break;default:const l=new Date(s);l.setDate(l.getDate()-7),a=l.toISOString(),c=o.toISOString()}return{start:a,end:c}},loadRecordings:async(e,t,o,s)=>{try{const a=new URLSearchParams;if(a.append("page",t.currentPage),a.append("limit",t.pageSize),a.append("sort",o),a.append("order",s),e.dateRange==="custom")a.append("start","".concat(e.startDate,"T").concat(e.startTime,":00")),a.append("end","".concat(e.endDate,"T").concat(e.endTime,":00"));else{const{start:n,end:p}=v.getDateRangeFromPreset(e.dateRange);a.append("start",n),a.append("end",p)}e.streamId!=="all"&&a.append("stream",e.streamId),e.recordingType==="detection"&&a.append("detection","1"),console.log("API Request:","/api/recordings?".concat(a.toString()));const c=await M("/api/recordings?".concat(a.toString()),{timeout:3e4,retries:2,retryDelay:1e3});if(console.log("Recordings data received:",c),c.recordings&&c.recordings.length>0)for(let p=0;p<c.recordings.length;p+=5){const h=c.recordings.slice(p,p+5);await Promise.all(h.map(async b=>{try{b.has_detections=await v.checkRecordingHasDetections(b)}catch(l){console.error("Error checking detections for recording ".concat(b.id,":"),l),b.has_detections=!1}}))}return c}catch(a){throw console.error("Error loading recordings:",a),f("Error loading recordings: "+a.message),a}},deleteRecording:async e=>{try{return await U("/api/recordings/".concat(e.id),{method:"DELETE",timeout:15e3,retries:1,retryDelay:1e3}),f("Recording deleted successfully"),!0}catch(t){return console.error("Error deleting recording:",t),f("Error deleting recording: "+t.message),!1}},deleteSelectedRecordings:async e=>{const t=Object.entries(e).filter(([o,s])=>s).map(([o,s])=>parseInt(o,10));if(t.length===0)return f("No recordings selected"),{succeeded:0,failed:0};try{if(window.wsClient&&window.wsClient.isConnected()){if(console.log("Using WebSocket for batch delete operation"),!window.batchDeleteClient)if(typeof BatchDeleteRecordingsClient<"u")window.batchDeleteClient=new BatchDeleteRecordingsClient(window.wsClient);else return console.warn("BatchDeleteRecordingsClient not available, falling back to HTTP"),v.deleteSelectedRecordingsHttp(t);return typeof showBatchDeleteModal=="function"&&showBatchDeleteModal(),await window.batchDeleteClient.deleteWithProgress({ids:t})}else return console.log("WebSocket not connected, using HTTP for batch delete"),v.deleteSelectedRecordingsHttp(t)}catch(o){return console.error("Error in batch delete operation:",o),f("Error in batch delete operation: "+o.message),{succeeded:0,failed:0}}},deleteSelectedRecordingsHttp:async e=>{try{const o=await(await U("/api/recordings/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e}),timeout:6e4,retries:1,retryDelay:2e3})).json(),s=o.succeeded,a=o.failed;return s>0&&a===0?f("Successfully deleted ".concat(s," recording").concat(s!==1?"s":"")):s>0&&a>0?f("Deleted ".concat(s," recording").concat(s!==1?"s":"",", but failed to delete ").concat(a)):f("Failed to delete ".concat(a," recording").concat(a!==1?"s":"")),o}catch(t){return console.error("Error in HTTP batch delete operation:",t),f("Error in batch delete operation: "+t.message),{succeeded:0,failed:0}}},deleteAllFilteredRecordings:async e=>{try{const t={};if(e.dateRange==="custom")t.start="".concat(e.startDate,"T").concat(e.startTime,":00"),t.end="".concat(e.endDate,"T").concat(e.endTime,":00");else{const{start:a,end:c}=v.getDateRangeFromPreset(e.dateRange);t.start=a,t.end=c}e.streamId!=="all"&&(t.stream_name=e.streamId),e.recordingType==="detection"&&(t.detection=1),console.log("Deleting with filter:",t),typeof showBatchDeleteModal=="function"&&(showBatchDeleteModal(),typeof window.updateBatchDeleteProgress=="function"&&window.updateBatchDeleteProgress({current:0,total:0,succeeded:0,failed:0,status:"Preparing to delete recordings matching filter...",complete:!1}));let o=0;try{const a=new URLSearchParams;t.start&&a.append("start",t.start),t.end&&a.append("end",t.end),t.stream_name&&a.append("stream",t.stream_name),t.detection&&a.append("detection","1"),a.append("page","1"),a.append("limit","1"),console.log("Getting total count with params:",a.toString());const c=await fetch("/api/recordings?".concat(a.toString()));if(c.ok){const n=await c.json();n&&n.pagination&&n.pagination.total&&(o=n.pagination.total,console.log("Found ".concat(o," recordings matching filter")),typeof window.updateBatchDeleteProgress=="function"&&window.updateBatchDeleteProgress({current:0,total:o,succeeded:0,failed:0,status:"Found ".concat(o," recordings matching filter. Starting deletion..."),complete:!1}))}}catch(a){console.warn("Error getting recording count:",a)}const s=a=>(console.error("Error in delete all operation:",a),f("Error in delete all operation: "+a.message),typeof window.updateBatchDeleteProgress=="function"&&window.updateBatchDeleteProgress({current:0,total:0,succeeded:0,failed:0,status:"Error: ".concat(a.message),complete:!0}),{succeeded:0,failed:0});if(window.wsClient&&window.wsClient.isConnected()){if(console.log("Using WebSocket for batch delete with filter"),!window.batchDeleteClient)if(typeof BatchDeleteRecordingsClient<"u")window.batchDeleteClient=new BatchDeleteRecordingsClient(window.wsClient);else return console.warn("BatchDeleteRecordingsClient not available, falling back to HTTP"),v.deleteAllFilteredRecordingsHttp(t);const a=new Promise((c,n)=>{setTimeout(()=>{n(new Error("Operation timed out or server crashed. Some recordings may have been deleted."))},6e4)});try{return await Promise.race([window.batchDeleteClient.deleteWithProgress({filter:t,totalCount:o}),a])}catch(c){return console.error("WebSocket error or timeout:",c),setTimeout(()=>{typeof loadRecordings=="function"&&loadRecordings()},1e3),s(c)}}else return console.log("WebSocket not connected, using HTTP for batch delete with filter"),v.deleteAllFilteredRecordingsHttp(t)}catch(t){return console.error("Error in delete all operation:",t),f("Error in delete all operation: "+t.message),{succeeded:0,failed:0}}},deleteAllFilteredRecordingsHttp:async e=>{try{const o=await(await U("/api/recordings/batch-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filter:e}),timeout:12e4,retries:1,retryDelay:3e3})).json(),s=o.succeeded,a=o.failed;return s>0&&a===0?f("Successfully deleted ".concat(s," recording").concat(s!==1?"s":"")):s>0&&a>0?f("Deleted ".concat(s," recording").concat(s!==1?"s":"",", but failed to delete ").concat(a)):f("Failed to delete ".concat(a," recording").concat(a!==1?"s":"")),o}catch(t){return console.error("Error in HTTP delete all operation:",t),f("Error in delete all operation: "+t.message),{succeeded:0,failed:0}}},checkRecordingHasDetections:async e=>{if(!e||!e.id||!e.stream||!e.start_time||!e.end_time)return!1;try{const t=Math.floor(new Date(e.start_time).getTime()/1e3),o=Math.floor(new Date(e.end_time).getTime()/1e3),s=new URLSearchParams({start:t,end:o}),a=await M("/api/detection/results/".concat(e.stream,"?").concat(s.toString()),{timeout:1e4,retries:1,retryDelay:500});return a.detections&&a.detections.length>0}catch(t){return console.error("Error checking detections:",t),!1}},getRecordingDetections:async e=>{if(!e||!e.id||!e.stream||!e.start_time||!e.end_time)return[];try{const t=Math.floor(new Date(e.start_time).getTime()/1e3),o=Math.floor(new Date(e.end_time).getTime()/1e3),s=new URLSearchParams({start:t,end:o});return(await M("/api/detection/results/".concat(e.stream,"?").concat(s.toString()),{timeout:15e3,retries:1,retryDelay:1e3})).detections||[]}catch(t){return console.error("Error getting detections:",t),[]}},playRecording:(e,t)=>{if(console.log("Play recording clicked:",e),!e.id){console.error("Recording has no id property:",e),f("Error: Recording has no id property");return}const o="/api/recordings/play/".concat(e.id),s="".concat(e.stream," - ").concat(B.formatDateTime(e.start_time)),a="/api/recordings/download/".concat(e.id);console.log("Video URL:",o),console.log("Title:",s),console.log("Download URL:",a),t(o,s,a),console.log("Video modal should be shown now")},downloadRecording:e=>{const t="/api/recordings/download/".concat(e.id),o=document.createElement("a");o.href=t,o.download="".concat(e.stream,"_").concat(new Date(e.start_time).toISOString().replace(/[:.]/g,"-"),".mp4"),document.body.appendChild(o),o.click(),document.body.removeChild(o),f("Download started")}},I={getFiltersFromUrl:()=>{const e=new URLSearchParams(window.location.search);if(!e.has("dateRange")&&!e.has("page")&&!e.has("sort")&&!e.has("detection")&&!e.has("stream"))return null;const t={filters:{dateRange:"last7days",startDate:"",startTime:"00:00",endDate:"",endTime:"23:59",streamId:"all",recordingType:"all"},page:1,limit:20,sort:"start_time",order:"desc"};return e.has("dateRange")&&(t.filters.dateRange=e.get("dateRange"),t.filters.dateRange==="custom"&&(e.has("startDate")&&(t.filters.startDate=e.get("startDate")),e.has("startTime")&&(t.filters.startTime=e.get("startTime")),e.has("endDate")&&(t.filters.endDate=e.get("endDate")),e.has("endTime")&&(t.filters.endTime=e.get("endTime")))),e.has("stream")&&(t.filters.streamId=e.get("stream")),e.has("detection")&&e.get("detection")==="1"&&(t.filters.recordingType="detection"),e.has("page")&&(t.page=parseInt(e.get("page"),10)),e.has("limit")&&(t.limit=parseInt(e.get("limit"),10)),e.has("sort")&&(t.sort=e.get("sort")),e.has("order")&&(t.order=e.get("order")),t},getActiveFiltersDisplay:e=>{const t=[];if(e.dateRange!=="last7days"||e.streamId!=="all"||e.recordingType!=="all"){if(e.dateRange!=="last7days"){let s="";switch(e.dateRange){case"today":s="Today";break;case"yesterday":s="Yesterday";break;case"last30days":s="Last 30 Days";break;case"custom":s="".concat(e.startDate," to ").concat(e.endDate);break}t.push({key:"dateRange",label:"Date: ".concat(s)})}e.streamId!=="all"&&t.push({key:"streamId",label:"Stream: ".concat(e.streamId)}),e.recordingType!=="all"&&t.push({key:"recordingType",label:"Detection Events Only"})}return t},loadFiltersFromUrl:(e,t,o,s,a,c)=>{const n=new URLSearchParams(window.location.search),p={...e};n.has("dateRange")&&(p.dateRange=n.get("dateRange"),p.dateRange==="custom"&&(n.has("startDate")&&(p.startDate=n.get("startDate")),n.has("startTime")&&(p.startTime=n.get("startTime")),n.has("endDate")&&(p.endDate=n.get("endDate")),n.has("endTime")&&(p.endTime=n.get("endTime")))),n.has("stream")&&(p.streamId=n.get("stream")),n.has("detection")&&n.get("detection")==="1"&&(p.recordingType="detection"),o(p),n.has("page")&&s(h=>({...h,currentPage:parseInt(n.get("page"),10)})),n.has("limit")&&s(h=>({...h,pageSize:parseInt(n.get("limit"),10)})),n.has("sort")&&a(n.get("sort")),n.has("order")&&c(n.get("order"))},updateUrlWithFilters:(e,t,o,s)=>{const a=new URLSearchParams(window.location.search);a.set("t",Date.now().toString()),a.set("dateRange",e.dateRange),e.dateRange==="custom"?(a.set("startDate",e.startDate),a.set("startTime",e.startTime),a.set("endDate",e.endDate),a.set("endTime",e.endTime)):(a.delete("startDate"),a.delete("startTime"),a.delete("endDate"),a.delete("endTime")),e.streamId!=="all"?a.set("stream",e.streamId):a.delete("stream"),e.recordingType==="detection"?a.set("detection","1"):a.delete("detection"),a.set("page",t.currentPage.toString()),a.set("limit",t.pageSize.toString()),a.set("sort",o),a.set("order",s);const c="".concat(window.location.pathname,"?").concat(a.toString());window.history.pushState({path:c},"",c);const n=c;window.onbeforeunload=function(){window.history.replaceState({path:n},"",n)}}};var de;function We(){const[e,t]=x([]),[o,s]=x([]),[a,c]=x(!0),[n,p]=x("start_time"),[h,b]=x("desc"),[l,m]=x({dateRange:"last7days",startDate:"",startTime:"00:00",endDate:"",endTime:"23:59",streamId:"all",recordingType:"all"}),[w,S]=x({currentPage:1,pageSize:20,totalItems:0,totalPages:1,startItem:0,endItem:0}),[_,k]=x(!1),[ge,ue]=x([]),[z,F]=x({}),[H,A]=x(!1),[pe,V]=x(!1),[W,me]=x("selected"),he=_e(null);K(()=>(j(),fe().then(()=>{const r=I.getFiltersFromUrl();if(r){console.log("Found URL filters:",r);const i=new URLSearchParams(window.location.search);i.has("detection")&&i.get("detection")==="1"&&(r.filters.recordingType="detection"),m(r.filters),S(g=>({...g,currentPage:r.page||1,pageSize:r.limit||20})),p(r.sort||"start_time"),b(r.order||"desc");const d={...w,currentPage:r.page||1,pageSize:r.limit||20};console.log("Making direct API call with filters:",r.filters),v.loadRecordings(r.filters,d,r.sort||"start_time",r.order||"desc").then(g=>{const u=g.recordings||[];t(u),T(u.length>0),E(g,r.page||1),P(!1)}).catch(g=>{console.error("Error loading recordings:",g),f("Error loading recordings: "+g.message),T(!1),P(!1)}),P(!0),T(!1),t([])}else C()}),O(),window.addEventListener("resize",O),()=>{window.removeEventListener("resize",O)}),[]),K(()=>{De()},[l]);const j=()=>{const r=new Date,i=new Date(r);i.setDate(r.getDate()-7),m(d=>({...d,endDate:r.toISOString().split("T")[0],startDate:i.toISOString().split("T")[0]}))},fe=async()=>{try{const r=await v.loadStreams();s(r)}catch(r){console.error("Error loading streams for filter:",r),f("Error loading streams: "+r.message)}},O=()=>{window.innerWidth<768?c(!1):c(!0)},ye=()=>{c(!a)},[be,P]=x(!1),[we,T]=x(!1),C=async(r=w.currentPage,i=!0)=>{console.log("Loading recordings with filters:",JSON.stringify(l));try{P(!0),T(!1),t([]);const d={...w,currentPage:r};i&&I.updateUrlWithFilters(l,d,n,h);const g=await v.loadRecordings(l,d,n,h),u=g.recordings||[];t(u),T(u.length>0),E(g,r)}catch(d){console.error("Error loading recordings:",d),f("Error loading recordings: "+d.message),T(!1)}finally{P(!1)}},E=(r,i)=>{if(i=i||w.currentPage,r.pagination){const d=r.pagination.limit||20,g=r.pagination.total||0,u=r.pagination.pages||1;let y=0,R=0;r.recordings.length>0&&(y=(i-1)*d+1,R=Math.min(y+r.recordings.length-1,g)),console.log("Pagination update:",{currentPage:i,pageSize:d,totalItems:g,totalPages:u,startItem:y,endItem:R,recordingsLength:r.recordings.length}),S(L=>({...L,totalItems:g,totalPages:u,pageSize:d,startItem:y,endItem:R}))}else{const d=w.pageSize,g=r.total||0,u=Math.ceil(g/d)||1;let y=0,R=0;r.recordings.length>0&&(y=(i-1)*d+1,R=Math.min(y+r.recordings.length-1,g)),console.log("Pagination update (fallback):",{currentPage:i,pageSize:d,totalItems:g,totalPages:u,startItem:y,endItem:R,recordingsLength:r.recordings.length}),S(L=>({...L,totalItems:g,totalPages:u,startItem:y,endItem:R}))}},ve=r=>{const i=r.target.value;if(m(d=>({...d,dateRange:i})),i==="custom"&&(!l.startDate||!l.endDate)){const d=new Date,g=new Date(d);g.setDate(d.getDate()-7),m(u=>({...u,endDate:d.toISOString().split("T")[0],startDate:g.toISOString().split("T")[0]}))}},De=()=>{const r=I.getActiveFiltersDisplay(l);k(r.length>0),ue(r)},N=(r=!0)=>{r&&S(i=>({...i,currentPage:1})),C(r?1:w.currentPage)},xe=()=>{const r={dateRange:"last7days",startDate:"",startTime:"00:00",endDate:"",endTime:"23:59",streamId:"all",recordingType:"all"},i=new Date,d=new Date(i);d.setDate(i.getDate()-7),r.endDate=i.toISOString().split("T")[0],r.startDate=d.toISOString().split("T")[0],m(r);const g={...w,currentPage:1};S(y=>({...y,currentPage:1}));const u=window.location.pathname;window.history.pushState({path:u},"",u),v.loadRecordings(r,g,"start_time","desc").then(y=>{t(y.recordings||[]),E(y,1)}).catch(y=>{console.error("Error loading recordings:",y),f("Error loading recordings: "+y.message)})},$e=r=>{switch(r){case"dateRange":m(i=>({...i,dateRange:"last7days"}));break;case"streamId":m(i=>({...i,streamId:"all"}));break;case"recordingType":m(i=>({...i,recordingType:"all"}));break}N()},ke=r=>{n===r?b(h==="asc"?"desc":"asc"):(b(r==="start_time"?"desc":"asc"),p(r)),C()},Se=r=>{if(r<1||r>w.totalPages)return;S(d=>({...d,currentPage:r}));const i={...w,currentPage:r};I.updateUrlWithFilters(l,i,n,h),setTimeout(()=>{C(r,!1)},0)},Re=r=>{F(i=>({...i,[r]:!i[r]}))},Te=()=>{const r=!H;A(r);const i={};r&&e.forEach(d=>{i[d.id]=!0}),F(i)},Y=()=>Object.values(z).filter(Boolean).length,Pe=r=>{me(r),V(!0)},J=()=>{V(!1)},Ce=async()=>{J();const r=new URLSearchParams(window.location.search),i=r.get("sort")||n,d=r.get("order")||h,g=parseInt(r.get("page"),10)||w.currentPage;if(W==="selected"){const u=await v.deleteSelectedRecordings(z);F({}),A(!1),u.succeeded>0&&G(i,d,g)}else{const u=await v.deleteAllFilteredRecordings(l);F({}),A(!1),u.succeeded>0&&C()}},G=(r,i,d)=>{p(r),b(i),S(g=>({...g,currentPage:d})),setTimeout(()=>{const g={...w,currentPage:d};I.updateUrlWithFilters(l,g,r,i),v.loadRecordings(l,g,r,i).then(u=>{console.log("Recordings data received:",u),t(u.recordings||[]),E(u,d)}).catch(u=>{console.error("Error loading recordings:",u),f("Error loading recordings: "+u.message)})},0)},Ie=async r=>{if(!confirm("Are you sure you want to delete this recording from ".concat(r.stream,"?")))return;const i=new URLSearchParams(window.location.search),d=i.get("sort")||n,g=i.get("order")||h,u=parseInt(i.get("page"),10)||w.currentPage;await v.deleteRecording(r)&&G(d,g,u)},Fe=r=>{v.playRecording(r,Oe)},Ee=r=>{v.downloadRecording(r)};return $(de||(de=D(['\n    <section id="recordings-page" class="page">\n      <div class="page-header flex justify-between items-center mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">\n        <div class="flex items-center">\n          <h2 class="text-xl font-bold">Recordings</h2>\n          <div class="ml-4 flex">\n            <a href="recordings.html" class="px-3 py-1 bg-blue-500 text-white rounded-l-md">Table View</a>\n            <a href="timeline.html" class="px-3 py-1 bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-r-md">Timeline View</a>\n          </div>\n        </div>\n        <button id="toggle-filters-btn" \n                class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 focus:outline-none"\n                title="Toggle Filters"\n                onClick=','>\n          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">\n            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>\n          </svg>\n        </button>\n      </div>\n      \n      <div class="recordings-layout flex flex-col md:flex-row gap-4 w-full">\n        <!-- Sidebar for filters -->\n        <',"\n          filters=","\n          setFilters=","\n          pagination=","\n          setPagination=","\n          streams=","\n          filtersVisible=","\n          applyFilters=","\n          resetFilters=","\n          handleDateRangeChange=","\n          setDefaultDateRange=",'\n        />\n        \n        <!-- Main content area -->\n        <div class="recordings-content flex-1">\n          <',"\n            activeFiltersDisplay=","\n            removeFilter=","\n            hasActiveFilters=","\n          />\n          \n          <","\n            isLoading=","\n            hasData=",'\n            loadingMessage="Loading recordings..."\n            emptyMessage="No recordings found matching your criteria"\n          >\n            <',"\n              recordings=","\n              sortField=","\n              sortDirection=","\n              sortBy=","\n              selectedRecordings=","\n              toggleRecordingSelection=","\n              selectAll=","\n              toggleSelectAll=","\n              getSelectedCount=","\n              openDeleteModal=","\n              playRecording=","\n              downloadRecording=","\n              deleteRecording=","\n              recordingsTableBodyRef=","\n              pagination=","\n            />\n            \n            <","\n              pagination=","\n              goToPage=","\n            />\n          <//>\n        </div>\n      </div>\n      \n      <","\n        isOpen=","\n        onClose=","\n        onConfirm=","\n        mode=","\n        count=","\n      />\n    </section>\n  "])),ye,Ue,l,m,w,S,o,a,N,xe,ve,j,Be,ge,$e,_,Le,be,we,He,e,n,h,ke,z,Re,H,Te,Y,Pe,Fe,Ee,Ie,he,w,Ve,w,Se,ze,pe,J,Ce,W,Y())}var ce;function Ge(){const e=document.getElementById("main-content");e&&Ae(async()=>{const{render:t}=await import("./preact-app-CvC8761_.js").then(o=>o.p);return{render:t}},__vite__mapDeps([0,1]),import.meta.url).then(({render:t})=>{t($(ce||(ce=D(["<"," />"])),We),e)})}export{We as RecordingsView,Ge as loadRecordingsView};
//# sourceMappingURL=RecordingsView-DarlQNHp.js.map
