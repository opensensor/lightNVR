name: Integration Tests

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libsqlite3-dev \
            libuv1-dev \
            libcurl4-openssl-dev \
            libcjson-dev \
            libmbedtls-dev \
            ffmpeg \
            curl \
            jq

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: go2rtc/go.sum

      - name: Build go2rtc from source
        run: |
          # Build go2rtc from the opensensor fork submodule
          cd go2rtc
          echo "Building go2rtc from source..."
          CGO_ENABLED=0 go build -ldflags "-s -w" -trimpath -o go2rtc
          chmod +x go2rtc
          ./go2rtc --version || echo "go2rtc built successfully"
          echo "go2rtc binary size: $(stat -c%s go2rtc) bytes"
          # Binary is now at go2rtc/go2rtc - exactly where lightnvr-test.ini expects it

      - name: Build lightNVR
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_GO2RTC=ON \
            -DGO2RTC_BINARY_PATH=$(pwd)/../go2rtc/go2rtc
          make -j$(nproc)
          echo "lightNVR built successfully"
          ls -la bin/lightnvr

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build web frontend
        run: |
          cd web
          npm ci
          npm run build
          echo "Web frontend built successfully"
          ls -la dist/ | head -10

      - name: Install Playwright dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Run Playwright UI tests
        run: |
          # Clean any existing playwright reports to ensure fresh state
          rm -rf playwright-report test-results
          mkdir -p playwright-report test-results

          # Run Playwright tests with output capture
          # global-setup.ts starts lightNVR which internally starts go2rtc
          # global-setup.ts then registers test streams via API
          set +e
          npx playwright test --project=ui 2>&1 | tee playwright-output.log
          RESULT=${PIPESTATUS[0]}
          set -e

          if [ $RESULT -ne 0 ]; then
            echo ""
            echo "=== Playwright tests failed ==="
            echo ""
            echo "Checking if lightNVR is still running..."
            pgrep -a lightnvr || echo "lightNVR is NOT running"
            pgrep -a go2rtc || echo "go2rtc is NOT running"
            echo ""
            echo "Checking lightNVR logs..."
            if [ -f /tmp/lightnvr-test/lightnvr.log ]; then
              echo "=== Last 200 lines of lightnvr.log ==="
              tail -200 /tmp/lightnvr-test/lightnvr.log
            else
              echo "No log file found at /tmp/lightnvr-test/lightnvr.log"
            fi
            echo ""
            echo "Checking for core dumps..."
            ls -la /tmp/core* 2>/dev/null || echo "No core dumps found"
            echo ""
            exit $RESULT
          fi
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots
          path: test-results/
          retention-days: 7

      - name: Upload lightNVR logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: lightnvr-logs
          path: |
            /tmp/lightnvr-test/
            playwright-output.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          # Stop any remaining processes
          pkill -f lightnvr || true
          pkill -f go2rtc || true

          # Clean up test artifacts
          rm -rf /tmp/lightnvr-test

